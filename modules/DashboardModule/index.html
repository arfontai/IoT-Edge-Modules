<!doctype html>
<html>
  <head>
    <title>Simple IoT Dashboard</title>
    <style>
      * { margin: 0; padding: 0; box-sizing: border-box; }
      body { font: 13px Helvetica, Arial; }
      form { background: #000; padding: 3px; position: fixed; bottom: 0; width: 100%; }
      form input { border: 0; padding: 10px; width: 90%; margin-right: .5%; }
      form button { width: 9%; background: rgb(130, 224, 255); border: none; padding: 10px; }
      #messages { list-style-type: none; margin: 0; padding: 0; }
      #messages li { padding: 5px 10px; }
      #messages li:nth-child(odd) { background: #eee; }
    </style>
  </head>
  <body>
      <div id="chart1" style="width:100%; height:400px;"></div>
      <div id="rawData" style="width:100%; overflow-y:scroll; height:600px">
        <h2>Raw data</h2>
        <ul id="messages"></ul>
      </div>
    
    <script src="/scripts/highcharts.js"></script>
    <script src="/scripts/modules/series-label.js"></script>
    <script src="/scripts/modules/exporting.js"></script>
    <script src="/scripts/modules/export-data.js"></script>
    <script src="/themes/dark-unica.js"></script>

    <script src="/socket.io/socket.io.js"></script>
    <!-- <script src="https://code.jquery.com/jquery-1.11.1.js"></script> -->
    <script src = "https://ajax.googleapis.com/ajax/libs/jquery/2.1.3/jquery.min.js"></script>

    <script>

      $(function () {
        var socket = io();

        var chartLine = Highcharts.chart('chart1', {
          chart: {
            type: 'spline',
            animation: Highcharts.svg,
            events: { }
          },
          title: { text: 'Temperature by Time(utc)' },
          subtitle: { text: 'Azure IoT Edge Dashboard module' },
          xAxis: { type: 'datetime', tickPixelInterval: 200 },
          yAxis: { 
            title: { text: 'Temperature (F)' },
            plotLines: [
              { value: 0.5, width: 1, color: '#808080' },
              { value: 0, width: 1, color: '#808080' }
            ]
          },
          legend: {
            layout: 'vertical',
            align: 'right',
            verticalAlign: 'middle'
          },
          tooltip: {
            formatter: function () {
              return '<b>' + this.series.name + '</b>' +
              Highcharts.dateFormat(' - %H:%M:%S %d/%m/%Y- ', this.x) + '' +
              '<b>' + Highcharts.numberFormat(this.y, 2) + '</b>';
            }
          },
          plotOptions: {
            series: {
                label: {
                    connectorAllowed: false
                }
            }
          },
          series: [
            {
              name: 'Temperature',
              data: (function () {
                // generate an array with 100 sample data (will size the data buffer)
                var data = [], time = (new Date()).getTime(), i;
                for (i = -100; i <= 0; i += 1) {
                  data.push({
                    x: time + i * 30000,
                    y: 30
                  });
                }
                return data;
              }())
            }
          ],
          responsive: {
            rules: [{
                condition: {
                    maxWidth: 500
                },
                chartOptions: {
                    legend: {
                        layout: 'horizontal',
                        align: 'center',
                        verticalAlign: 'bottom'
                    }
                }
            }]
          }
        });

        $('form').submit(function(e){
          e.preventDefault(); // prevents page reloading
          socket.emit('iot message', $('#m').val());
          $('#m').val('');
          return false;
        });
      
        socket.on('iot message', function(msg){
          $('#messages').append($('<li>').text(msg));

          var json = $.parseJSON(msg);
          var timestamp = (new Date(json.TimeCreated)).getTime();
        
          var seriesModule1 = chartLine.series[0];
          var x = timestamp, // UTC time
              y = json.Machine.Temperature;
          seriesModule1.addPoint([x, y], true, true);
        });
      });
    </script>
  </body>
</html>